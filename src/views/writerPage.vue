<!-- ä½œå“(çº¯æ–‡æœ¬)ç¼–å†™é¡µ -->
<template>
    <TitleBlock></TitleBlock>
    <div v-if="showkeywordDetail" ref="keywordDetail" class="keyword-detail">
        <div class="keyword-head">
            <div class="head-left">
                <img src="http://v.bootstrapmb.com/2019/10/6bsjf6461/images/case-logo002.png" />
            </div>
            <div class="head-middle">
                <ul>
                    <li>ğŸ”¸å¥¥å…¹</li>
                    <li>ğŸ”¸å¥¥å…¹è«å¥¥å…¹è«å¥¥å…¹è«å¥¥å…¹è«</li>
                    <li>ğŸ”¸Ozmo</li>
                </ul>
            </div>
            <div class="head-right">
                <a-space size="mini" direction="vertical">
                    <a-popover
                        style="max-width: 300px;"
                        trigger="click"
                        position="rt"
                        title="ä¸»å9999ä¸»å999ä¸»å9999ä¸»å9999ä¸»ä¸»å9999ä¸»å999ä¸»å9999ä¸»å9999ä¸»å9"
                    >
                        <span title="æŸ¥çœ‹æ›´å¤š">
                            <icon-apps />
                        </span>
                        <template #content>
                            <div class="popover-content">
                                <span>æ‹œè’™(åŒæ€§é­”)çš„ç”·æ€§ä½“ã€‚è´åˆ©å°”ä»¤è‡³ä¸Šä¸‰æŸ±ç§˜å¯†è¯›æ€ã€‚æ‹œè’™ä¸æ•Œï¼Œèº¯ä½“æ¶ˆé€ã€é­‚é­„ç¢è£‚ã€‚ä½†å°±åœ¨åƒé’§ä¸€å‘ä¹‹é™…ï¼Œæ­»ç¥é˜¿åŠªæ¯”æ–¯å°†å¼¥æ•£çš„é­‚é­„æ®‹ç‰‡é‡æ–°å¯»å›ï¼Œå°†æ‹œè’™çš„ç”·æ€§é¢å¸¦å…¥äº†å†¥ç•Œï¼Œè€Œå¥³æ€§é¢åˆ™ä¸çŸ¥å»å‘ã€‚å¦‚ä»Šå¯„å®¿åœ¨ä¸€ä¸ªåå«å¥¥å…¹è«(Ozmo)çš„å¹´è½»äºº(å·²æ­»)èº«ä¸Šã€‚ä»£å·ï¼šsr-kn103æ‹œè’™(åŒæ€§é­”)çš„ç”·æ€§ä½“ã€‚è´åˆ©å°”ä»¤è‡³ä¸Šä¸‰æŸ±ç§˜å¯†è¯›æ€ã€‚æ‹œè’™ä¸æ•Œï¼Œèº¯ä½“æ¶ˆé€ã€é­‚é­„ç¢è£‚ã€‚ä½†å°±åœ¨åƒé’§ä¸€å‘ä¹‹é™…ï¼Œæ­»ç¥é˜¿åŠªæ¯”æ–¯å°†å¼¥æ•£çš„é­‚é­„æ®‹ç‰‡é‡æ–°å¯»å›ï¼Œå°†æ‹œè’™çš„ç”·æ€§é¢å¸¦å…¥äº†å†¥ç•Œï¼Œè€Œå¥³æ€§é¢åˆ™ä¸çŸ¥å»å‘ã€‚å¦‚ä»Šå¯„å®¿åœ¨ä¸€ä¸ªåå«å¥¥å…¹è«(Ozmo)çš„å¹´è½»äºº(å·²æ­»)èº«ä¸Šã€‚ä»£å·ï¼šsr-kn103</span>
                            </div>
                        </template>
                    </a-popover>
                    <span title="ä¸‹ä¸€é¡µ">
                        <icon-caret-right />
                    </span>
                    <span title="ä¸Šä¸€é¡µ">
                        <icon-caret-left />
                    </span>
                </a-space>
            </div>
        </div>
        <div class="keyword-middle">
            <a-space wrap size="mini">
                <a-tag
                    style="max-width: 200px;border-radius: 5px;"
                    color="arcoblue"
                >æ€§åˆ«å¤§å¸ˆå‚…å£«å¤§å¤«å£«å¤§å¤«æ’’æ—¦ğŸ”¸ç”·sdasdasdå®æ‰“å®å¤§è‹æ‰“å‘vå¤§å¸ˆå²è’‚èŠ¬</a-tag>
                <a-tag style="max-width: 200px;border-radius: 5px;" color="arcoblue">æ€§åˆ«ğŸ”¸ç”·</a-tag>
                <a-tag style="max-width: 200px;border-radius: 5px;" color="arcoblue">æ€§åˆ«ğŸ”¸ç”·</a-tag>
                <a-tag
                    style="max-width: 200px;border-radius: 5px;"
                    color="arcoblue"
                >æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·æ€§åˆ«ğŸ”¸ç”·</a-tag>
                <a-tag style="max-width: 200px;border-radius: 5px;" color="arcoblue">æ€§åˆ«ğŸ”¸ç”·</a-tag>
                <a-tag style="max-width: 200px;border-radius: 5px;" color="arcoblue">æ€§åˆ«ğŸ”¸ç”·</a-tag>
                <a-tag style="max-width: 200px;border-radius: 5px;" color="arcoblue">æ€§åˆ«ğŸ”¸ç”·</a-tag>
            </a-space>
        </div>
        <div class="keyword-bottom"></div>
        <div class="panel-btn" title="å”¤å‡ºå…³é”®å­—é¢æ¿">ğŸ›©ï¸</div>
    </div>
    <PopupMenu
        v-if="isRename"
        title="é‡å‘½å"
        determine="ç¡®å®š"
        @toModify="modify"
        @toDetermine="reName"
        :determineDisabled="showName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="åç§°">
                <a-input
                    v-model.trim="showName"
                    style="width: 370px"
                    :max-length="25"
                    :error="showName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="è¯·è¾“å…¥ç« å..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <PopupMenu
        v-if="isNewVolume"
        title="æ–°å¢å·"
        determine="ç¡®å®š"
        @toModify="modify"
        @toDetermine="addNewVolume"
        :determineDisabled="volumeName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="å·å">
                <a-input
                    v-model.trim="volumeName"
                    style="width: 370px"
                    :max-length="25"
                    :error="volumeName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="è¯·è¾“å…¥å·å..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <PopupMenu
        v-if="isNewChapter"
        title="æ–°å¢ç« "
        determine="ç¡®å®š"
        @toModify="modify"
        @toDetermine="addNewChapter"
        :determineDisabled="chapterName.length === 0"
    >
        <a-space>
            <a-form-item field="name" label="ç« å">
                <a-input
                    v-model.trim="chapterName"
                    style="width: 370px"
                    :max-length="25"
                    :error="chapterName.length === 0"
                    show-word-limit
                    allow-clear
                    placeholder="è¯·è¾“å…¥ç« å..."
                />
            </a-form-item>
        </a-space>
    </PopupMenu>
    <div class="layout-write">
        <a-layout>
            <a-layout-header>
                <div class="head-item">
                    <!-- å…¨å±æ´å‡€æ¨¡å¼ -->
                    <a-tooltip background-color="#3491FA" mini content="å…¨å±æ´å‡€æ¨¡å¼(F1)">
                        <a-button class="headerBtn">
                            <icon-fullscreen />&nbsp;å…¨å±
                        </a-button>
                    </a-tooltip>
                    <!-- æ–‡å­—è®¾ç½® -->
                    <a-dropdown trigger="hover">
                        <a-button class="headerBtn" style="padding-right: 0;">
                            <img :src="writtenwords" style="transform: translateY(2px)" />&nbsp;&nbsp;æ–‡å­—
                            <icon-down />
                        </a-button>
                        <template #content>
                            <a-trigger position="right" :popup-translate="[5, 16]">
                                <a-doption>
                                    <img :src="fontSizeIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;å­—ä½“å¤§å°
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding:0 10px;">
                                        <a-input-number
                                            v-model="fontSize"
                                            :min="1"
                                            :max="50"
                                            mode="button"
                                            style="width:108px"
                                            @change="changeFontSize()"
                                        />
                                        <a-slider
                                            v-model="fontSize"
                                            :step="1"
                                            :min="1"
                                            :max="50"
                                            :marks="{ 1: '1px', 22: '22px', 50: '50px' }"
                                            :format-tooltip="(value: number) => {
                                                return `${value}px`;
                                            }"
                                            :style="{ width: '280px', transform: 'translateY(4px)' }"
                                            @change="changeFontSize()"
                                        />
                                    </a-space>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="lineHeighIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;å­—ç¬¦è¡Œé«˜
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding:0 10px;">
                                        <a-input-number
                                            v-model="lineHeight"
                                            :step="0.05"
                                            :min="0"
                                            :max="5"
                                            mode="button"
                                            :style="{ width: '108px' }"
                                            @change="changeLineHeight()"
                                        />
                                        <a-slider
                                            v-model="lineHeight"
                                            :step="0.05"
                                            :min="0"
                                            :max="5"
                                            :marks="{ 0: '0em', 1.5: '1.5em', 5: '5em' }"
                                            :format-tooltip="(value: number) => {
                                                return `${value}em`;
                                            }"
                                            :style="{ width: '280px', transform: 'translateY(4px)' }"
                                            @change="changeLineHeight()"
                                        />
                                    </a-space>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="fontWeightIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ–‡å­—ç²—ç»†
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding: 10px 20px;">
                                        <a-radio-group
                                            v-model="fontWeight"
                                            @change="changeFontWeight"
                                            direction="vertical"
                                        >
                                            <a-radio value="lighter">lighter</a-radio>
                                            <a-radio value="normal">normal</a-radio>
                                            <a-radio value="bold">bold</a-radio>
                                        </a-radio-group>
                                    </a-space>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="fontFamilyIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;é€‰æ‹©å­—ä½“
                                </a-doption>
                                <template #content>
                                    <ul
                                        class="trigger typeface"
                                        @scroll="fontlistScroll"
                                        ref="fontListNode"
                                    >
                                        <li
                                            class="typeface-head"
                                            title="ç‚¹å‡»æ¢å¤é»˜è®¤"
                                        >{{ uWritingOption.uFont }}</li>
                                        <li
                                            v-for="(item, i) in fontList"
                                            :key="i"
                                            :title="item"
                                            :style="{ fontFamily: item }"
                                            @click="selectFont(i)"
                                        >{{ item }}</li>
                                    </ul>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="fontColorIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ–‡å­—é¢œè‰²
                                </a-doption>
                                <template #content>
                                    <div class="trigger" style="margin-top: 24px;">
                                        <color-picker
                                            :isWidget="true"
                                            :format="'hex'"
                                            v-model:pureColor="fontColor"
                                            v-model:gradientColor="gradientColor"
                                            @pureColorChange="getColor"
                                        />
                                    </div>
                                </template>
                            </a-trigger>
                        </template>
                    </a-dropdown>
                    <!-- æ®µè½è®¾ç½® -->
                    <a-dropdown trigger="hover">
                        <a-button class="headerBtn" style="padding-right: 0;">
                            <img :src="paragraphIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ®µè½
                            <icon-down />
                        </a-button>
                        <template #content>
                            <a-trigger position="right" :popup-translate="[5, 16]">
                                <a-doption>
                                    <img :src="segSpacingIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ®µè½é—´è·
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding: 0 10px;">
                                        <a-input-number
                                            v-model="segSpacing"
                                            :min="0"
                                            :max="100"
                                            mode="button"
                                            :style="{ width: '108px' }"
                                            @change="changeSegSpacing()"
                                        />
                                        <a-slider
                                            v-model="segSpacing"
                                            :min="0"
                                            :max="100"
                                            :marks="{ 0: '0px', 10: '10px', 100: '100px' }"
                                            :format-tooltip="(value: number) => {
                                                return `${value}px`;
                                            }"
                                            :style="{ width: '280px', transform: 'translateY(4px)' }"
                                            @change="changeSegSpacing()"
                                        />
                                    </a-space>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 30]">
                                <a-doption>
                                    <img :src="textIndentIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ®µå‰ç¼©è¿›
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding: 10px 20px;">
                                        <a-radio-group
                                            v-model="textIndent"
                                            @change="changeTextIndent"
                                            direction="vertical"
                                        >
                                            <a-radio value="0">0em</a-radio>
                                            <a-radio value="1">1em</a-radio>
                                            <a-radio value="2">2em</a-radio>
                                            <a-radio value="3">3em</a-radio>
                                            <a-radio value="4">4em</a-radio>
                                        </a-radio-group>
                                    </a-space>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="paraFocusIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;æ®µè½èšç„¦
                                </a-doption>
                                <template #content>
                                    <a-space class="trigger" style="padding: 10px 20px;">
                                        <a-radio-group
                                            v-model="paraFocus"
                                            @change="changeParaFocus"
                                            direction="vertical"
                                        >
                                            <a-radio value="open">å¼€å¯</a-radio>
                                            <a-radio value="close">å…³é—­</a-radio>
                                        </a-radio-group>
                                    </a-space>
                                </template>
                            </a-trigger>
                        </template>
                    </a-dropdown>
                    <!-- å…¶å®ƒè®¾ç½® -->
                    <a-dropdown trigger="hover">
                        <a-button class="headerBtn">
                            <img :src="otherSettingIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;å…¶å®ƒ
                            <icon-down />
                        </a-button>
                        <template #content>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="paperColorIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;çº¸å¼ é¢œè‰²
                                </a-doption>
                                <template #content>
                                    <div class="trigger" style="margin-top: 76px;">
                                        <color-picker
                                            :isWidget="true"
                                            v-model:pureColor="bgcColor"
                                            v-model:gradientColor="gradientColor"
                                            @pureColorChange="getBgcColor"
                                        />
                                    </div>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[5, 0]">
                                <a-doption>
                                    <img :src="paperSizeIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;çº¸å¼ å¤§å°
                                </a-doption>
                                <template #content>
                                    <ul class="trigger typeface paper-size">
                                        <li
                                            v-for="item in paperSize"
                                            :key="item.type"
                                            :style="item.now ? 'background-color: #3491fa;color: #fff;' : ''"
                                            @click="changePaperSize(item.type)"
                                        >
                                            <span>{{ item.type }}</span>
                                            <span>{{ item.size + 'px' }}</span>
                                        </li>
                                    </ul>
                                </template>
                            </a-trigger>
                            <a-trigger position="right" :popup-translate="[8, 0]">
                                <a-doption>
                                    <img :src="softThemeIcon" style="transform: translateY(2px)" />&nbsp;&nbsp;è½¯ä»¶ä¸»é¢˜
                                </a-doption>
                                <template #content></template>
                            </a-trigger>
                        </template>
                    </a-dropdown>
                    <!-- å¯¼å‡º -->
                    <a-dropdown trigger="hover">
                        <a-button class="headerBtn" style="padding-right: 0;">
                            <icon-export />&nbsp;&nbsp;å¯¼å‡º
                            <icon-caret-down />
                        </a-button>
                        <template #content>
                            <a-doption @click="exp('txt')">
                                <img :src="expTXTIcon" style="transform: translateY(4px)" />&nbsp;&nbsp;å¯¼å‡ºä¸º&nbsp;&nbsp;TXT
                            </a-doption>
                            <a-doption @click="exp('docx')">
                                <img :src="expDOCXIcon" style="transform: translateY(4px)" />&nbsp;&nbsp;å¯¼å‡ºä¸º&nbsp;&nbsp;DOCX
                            </a-doption>
                            <a-doption @click="exp('pdf')">
                                <img :src="expPDFIcon" style="transform: translateY(4px)" />&nbsp;&nbsp;å¯¼å‡ºä¸º&nbsp;&nbsp;PDF
                            </a-doption>
                        </template>
                    </a-dropdown>
                    <!-- å­—æ•°ç»Ÿè®¡ -->
                    <a-dropdown trigger="hover">
                        <a-button
                            class="headerBtn"
                            :style="wordCount >= 15000 ? 'color : #f53f3f' : ''"
                        >
                            <icon-book />
                            &nbsp;&nbsp;{{ showChoice }}
                            <icon-caret-down />
                        </a-button>
                        <template #content>
                            <a-doption
                                @click="choice(0)"
                                :style="choiceArr[0] ? 'color: #165dff;' : ''"
                            >
                                <icon-check-circle
                                    :style="choiceArr[0] ? '' : 'visibility:hidden'"
                                />
                                &nbsp;å­—æ•°&nbsp;&nbsp;&nbsp;&nbsp;{{ wordCount }}å­—
                            </a-doption>
                            <a-doption
                                @click="choice(1)"
                                :style="choiceArr[1] ? 'color: #165dff;' : ''"
                            >
                                <icon-check-circle
                                    :style="choiceArr[1] ? '' : 'visibility:hidden'"
                                />
                                &nbsp;å­—ç¬¦&nbsp;&nbsp;&nbsp;&nbsp;{{ charCount }}ä¸ª
                            </a-doption>
                            <a-doption
                                @click="choice(2)"
                                :style="choiceArr[2] ? 'color: #165dff;' : ''"
                            >
                                <icon-check-circle
                                    :style="choiceArr[2] ? '' : 'visibility:hidden'"
                                />
                                &nbsp;æ®µè½&nbsp;&nbsp;&nbsp;&nbsp;{{ paragraphs }}æ®µ
                            </a-doption>
                        </template>
                    </a-dropdown>
                </div>
            </a-layout-header>
            <a-layout>
                <a-layout-sider collapsible class="siderLeft">
                    <a-menu
                        :default-open-keys="[vid]"
                        :default-selected-keys="[cid]"
                        :style="{ width: '100%', textAlign: 'left' }"
                    >
                        <button @click="isNewVolume = true" class="topBtn">
                            <!-- <img :src="addVolumeIcon" style="transform: translateY(4px)" /> -->
                            <span style="transform: translateY(4px)">ğŸ“œ</span>
                            <span>æ·»åŠ å·</span>
                        </button>
                        <a-sub-menu v-for="item in booksLists.data" :key="item.vid">
                            <template #title>
                                <icon-double-right
                                    @click.stop="showLeftMore = showLeftMore === item.vid ? '' : item.vid"
                                    class="siderLeft-btn"
                                />
                                <span title="åˆ é™¤å·">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        style="margin-bottom: -5px; margin-right: 5px;margin-left: 5px;"
                                        @mouseenter="editVid1 = item.vid"
                                        @mouseleave="editVid1 = ''"
                                        @click.stop="deleteVolume(item.vid, item.volumeName)"
                                    >
                                        <path
                                            p-id="3022"
                                            :fill="editVid1 === item.vid ? '#bf5e00' : '#ff7d00'"
                                        />
                                    </svg>
                                </span>
                                <span title="é‡å‘½å">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="20"
                                        height="20"
                                        style="margin-bottom: -5px; margin-right: 5px;"
                                        @mouseenter="editVid2 = item.vid"
                                        @mouseleave="editVid2 = ''"
                                        @click.stop="showReName('v', item.vid, item.volumeName)"
                                    >
                                        <path
                                            :fill="editVid2 === item.vid ? '#276dbc' : '#3491fa'"
                                            p-id="3276"
                                        />
                                    </svg>
                                </span>
                                <span title="æ–°å¢ç« ">
                                    <svg
                                        v-if="showLeftMore === item.vid"
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="18"
                                        height="18"
                                        style="margin-bottom: -4px; margin-right: 5px;"
                                        @mouseenter="editVid3 = item.vid"
                                        @mouseleave="editVid3 = ''"
                                        @click.stop="newChapter(item.vid)"
                                    >
                                        <path
                                            p-id="1550"
                                            :fill="editVid3 === item.vid ? '#008720' : '#00b42a'"
                                        />
                                    </svg>
                                </span>
                                {{ item.volumeName }}
                            </template>
                            <a-dropdown
                                v-for="it in item.volume"
                                :key="it.cid"
                                trigger="contextMenu"
                                alignPoint
                                :style="{ display: 'block' }"
                            >
                                <a-menu-item
                                    :key="it.cid"
                                    @click="onClickMenuItem(item.vid, it.cid)"
                                    :style="deletedCid === it.cid ? 'color:#f53f3f;text-decoration:line-through;text-indent:10px;' : 'text-indent:10px;'"
                                    :title="it.chapterName"
                                >{{ it.chapterName }}</a-menu-item>
                                <template #content>
                                    <a-doption @click="showReName('c', it.cid, it.chapterName)">é‡å‘½å</a-doption>
                                    <a-doption
                                        @click="deleteChapter(item.vid, it.cid, it.chapterName)"
                                    >åˆ é™¤ç« </a-doption>
                                </template>
                            </a-dropdown>
                        </a-sub-menu>
                    </a-menu>
                    <template #trigger="{ collapsed }">
                        <IconCaretRight v-if="collapsed"></IconCaretRight>
                        <IconCaretLeft v-else></IconCaretLeft>
                    </template>
                </a-layout-sider>
                <a-layout-content
                    @mouseover="showScroll"
                    @mouseout="closeScroll"
                    @scroll="getScrollTop"
                >
                    <div v-if="showSearchBox" class="search-box">
                        <a-space
                            direction="vertical"
                            align="start"
                            size="mini"
                            style="padding:0 4px;"
                        >
                            <a-space style="padding-bottom: 4px;border-bottom:1px solid #ccc;">
                                <icon-search />
                                <input
                                    v-model="searchData"
                                    ref="searchInput"
                                    @input="toSearchKeyword"
                                    type="text"
                                    placeholder="æŸ¥æ‰¾"
                                />
                                <span
                                    class="show-keywordCount"
                                >{{ keyWordPos > 9999 ? '9999+' : keyWordPos }}/{{ totalKeyWord > 9999 ? '9999+' : totalKeyWord }}</span>
                                <a-space size="mini">
                                    <span
                                        @click="mainStore.updateTargetIndex(-1), toSearchKeyword()"
                                        class="mini-btn"
                                        title="ä¸Šä¸€ä¸ª"
                                    >
                                        <icon-arrow-up />
                                    </span>
                                    <span
                                        @click="mainStore.updateTargetIndex(1), toSearchKeyword()"
                                        class="mini-btn"
                                        title="ä¸‹ä¸€ä¸ª"
                                    >
                                        <icon-arrow-down />
                                    </span>
                                    <span @click="stopSearchKeyword" class="mini-btn" title="å…³é—­">
                                        <icon-close />
                                    </span>
                                </a-space>
                            </a-space>
                            <a-space>
                                <icon-undo style="transform: rotateZ(180deg);" />
                                <input v-model="replaceData" type="text" placeholder="æ›¿æ¢" />
                                <span @click="replaceKeyword('single')" class="mini-btn" title="æ›¿æ¢">
                                    <svg
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        style="margin-bottom: -2px;"
                                    >
                                        <path p-id="3277" />
                                    </svg>
                                </span>
                                <span
                                    @click="replaceKeyword('whole')"
                                    class="mini-btn"
                                    title="å…¨éƒ¨æ›¿æ¢"
                                >
                                    <svg
                                        viewBox="0 0 1024 1024"
                                        xmlns="http://www.w3.org/2000/svg"
                                        width="14"
                                        height="14"
                                        style="margin-bottom: -2px;"
                                    >
                                        <path p-id="9876" />
                                    </svg>
                                </span>
                            </a-space>
                        </a-space>
                    </div>
                    <WritingPaper @todata="getData" ref="myRef"></WritingPaper>
                </a-layout-content>
                <a-resize-box
                    @moving-start="showIframeWrap = true"
                    @moving-end="showIframeWrap = false"
                    @moving="resizeBoxMoving"
                    :directions="['left']"
                    class="sider-right"
                    style="width: 200px;"
                >
                    <!-- ä¼¸ç¼©æ† -->
                    <template #resize-trigger="{ direction }">
                        <div
                            :class="[
                                `resizebox-demo`,
                                `resizebox-demo-${direction === 'left' ? 'vertical' : 'horizontal'}`
                            ]"
                        >
                            <div class="resizebox-demo-line" />
                        </div>
                    </template>
                    <!-- å†…å®¹åŒº -->
                    <div class="sider-right-content">
                        <!-- æ¼‚æµ®å·¥å…·æ  -->
                        <a-trigger
                            :trigger="['click']"
                            clickToClose
                            position="bottom"
                            v-model:popupVisible="popupVisible"
                        >
                            <div
                                :class="`button-trigger ${popupVisible ? 'button-trigger-active' : ''}`"
                            >
                                <IconClose v-if="popupVisible" />
                                <IconMessage v-else />
                            </div>
                            <template #content>
                                <a-menu
                                    mode="popButton"
                                    :tooltipProps="{ position: 'left', backgroundColor: '#3491fa', mini: true }"
                                    showCollapseButton
                                    @menu-item-click="choicePopButton"
                                >
                                    <a-menu-item style="margin: 10px 0;" key="1">
                                        <template #icon>
                                            <img :src="svg_plot" />
                                        </template>
                                        å‰§æƒ…
                                    </a-menu-item>
                                    <a-menu-item style="margin: 10px 0;" key="2">
                                        <template #icon>
                                            <img :src="svg_keyword" />
                                        </template>
                                        å…³é”®å­—
                                    </a-menu-item>
                                    <a-menu-item style="margin: 10px 0;" key="3">
                                        <template #icon>
                                            <img :src="svg_diagram" />
                                        </template>
                                        å…³ç³»å›¾
                                    </a-menu-item>
                                    <a-menu-item style="margin: 10px 0;" key="4">
                                        <template #icon>
                                            <img :src="svg_timeline" />
                                        </template>
                                        æ—¶é—´çº¿
                                    </a-menu-item>
                                    <a-menu-item style="margin: 10px 0;" key="5">
                                        <template #icon>
                                            <img :src="svg_map" />
                                        </template>
                                        åœ°å›¾
                                    </a-menu-item>
                                </a-menu>
                            </template>
                        </a-trigger>
                        <PlotEditor v-if="showModular === '1'"></PlotEditor>
                        <KeywordEditor v-if="showModular === '2'"></KeywordEditor>
                        <DiagramEditor v-if="showModular === '3'"></DiagramEditor>
                        <TimelineEditor v-if="showModular === '4'" ref="ref_TimelineEditor"></TimelineEditor>
                        <MapEditor v-if="showModular === '5'"></MapEditor>
                        <div v-if="showIframeWrap" class="iframe-Wrap"></div>
                    </div>
                    <!-- <webview class="iframe" src="https://wantwords.net/"></webview> -->
                    <!-- <iframe class="iframe" src="https://wantwords.net/"></iframe> -->
                </a-resize-box>
            </a-layout>
        </a-layout>
    </div>
</template>

<script setup lang="ts">
import { ref, computed, onUnmounted, reactive, onMounted, nextTick, onBeforeUnmount, watch, Ref } from 'vue';
import {
    IconDown, IconExport, IconCaretRight, IconCaretLeft, IconClose, IconUndo,
    IconBook, IconCaretDown, IconCheckCircle, IconFullscreen, IconMessage,
    IconDoubleRight, IconSearch, IconArrowUp, IconArrowDown, IconApps
} from '@arco-design/web-vue/es/icon';
import TitleBlock from '../components/TitleBlock.vue';
import WritingPaper from '../components/WritingPaper.vue';
import PopupMenu from '../components/widget/PopupMenu.vue';
import PlotEditor from '../components/PlotEditor.vue';
import KeywordEditor from '../components/KeywordEditor.vue';
import DiagramEditor from '../components/DiagramEditor.vue';
import TimelineEditor from '../components/TimelineEditor.vue';
import MapEditor from '../components/MapEditor.vue';
import { useRoute, useRouter } from 'vue-router';
import { ColorPicker } from "vue3-colorpicker";
import "vue3-colorpicker/style.css";
import { throttle } from '../utils/flowControl';
import { db } from '../db/db';
import useCurrentInstance from '../utils/useCurrentInstance';
import { v4 } from 'uuid';
import genkeywordMarks from '../utils/genkeywordMarks';
// import { setHighlightKeyword } from '../common/editor/syntax';
import { useMainStore } from '../store/index';
import writtenwords from '../assets/svg/writtenwords.svg';
import fontSizeIcon from '../assets/svg/fontSizeIcon.svg';
import lineHeighIcon from '../assets/svg/lineHeighIcon.svg';
import fontWeightIcon from '../assets/svg/fontWeightIcon.svg';
import fontFamilyIcon from '../assets/svg/fontFamilyIcon.svg';
import fontColorIcon from '../assets/svg/fontColorIcon.svg';
import paragraphIcon from '../assets/svg/paragraphIcon.svg';
import segSpacingIcon from '../assets/svg/segSpacingIcon.svg';
import textIndentIcon from '../assets/svg/textIndentIcon.svg';
import paraFocusIcon from '../assets/svg/paraFocusIcon.svg';
import otherSettingIcon from '../assets/svg/otherSettingIcon.svg';
import paperColorIcon from '../assets/svg/paperColorIcon.svg';
import paperSizeIcon from '../assets/svg/paperSizeIcon.svg';
import softThemeIcon from '../assets/svg/softThemeIcon.svg';
import expTXTIcon from '../assets/svg/expTXTIcon.svg';
import expDOCXIcon from '../assets/svg/expDOCXIcon.svg';
import expPDFIcon from '../assets/svg/expPDFIcon.svg';
import svg_plot from '../assets/svg/plot.svg';
import svg_keyword from '../assets/svg/keyword.svg';
import svg_diagram from '../assets/svg/diagram.svg';
import svg_timeline from '../assets/svg/timeline.svg';
import svg_map from '../assets/svg/map.svg';
import '../style/writerPage.scss';

const { proxy } = useCurrentInstance();
const $modal = proxy.$modal;
const $message = proxy.$message;
const route = useRoute();
const query_id = parseInt(<string>route.query.id);
const vid = ref(route.query.vid);
const cid = ref(route.query.cid);
const mainStore = useMainStore();
const ref_TimelineEditor = ref();
loadListData();

const showIframeWrap = ref(false), showSearchBox = ref(false);
const keywordMarks: Ref<Array<{
    match: RegExp, class: string, style: string
}>> = ref([]);
/*------------å…³é”®è¯æœç´¢ã€æ›¿æ¢åŠŸèƒ½------------*/
const searchData = ref(''), replaceData = ref(''),
    totalKeyWord = ref(0), keyWordPos = ref(0);
watch(showSearchBox, value => {
    mainStore.isInSearch = value
    if (value && searchData.value !== '') toSearchKeyword();
})
// å…³é”®å­—ç»Ÿè®¡
let isHighlightCount = computed(() => mainStore.isHighlightCount);
watch(isHighlightCount, () => {
    if (showSearchBox.value && searchData.value !== '') {
        totalKeyWord.value = mainStore.highlightCount;
        if (totalKeyWord.value === 0) {
            keyWordPos.value = 0;
        } else {
            keyWordPos.value = mainStore.targetIndex;
        }
    } else {
        keyWordPos.value = totalKeyWord.value = 0;
    }
})
watch(searchData, () => {
    mainStore.targetIndex = 1;
})
const toSearchKeyword = () => {
    db.opus.get(query_id).then(value => {
        if (value) myRef.value.setBooksData(value, [{ match: new RegExp(searchData.value, 'g'), class: 'keyword_search' }]);
        [...document.querySelectorAll('.keyword_search')].forEach(el => {
            if (el.id === 'search-anchor') {
                const viewportHeight = document.querySelector('.arco-layout-content')?.clientHeight!;
                // é”šç‚¹é“¾æ¥è·³è½¬åˆ°å½“å‰é«˜äº®å…³é”®å­—
                const distanceFromViewport = el.getBoundingClientRect().top - 75;
                if (distanceFromViewport > viewportHeight || distanceFromViewport < 0) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        })
    })
}
// æ›¿æ¢å…³é”®å­—
const replaceKeyword = (type: 'single' | 'whole') => {
    if (type === 'single') {
        [...document.querySelectorAll('.keyword_search')].forEach(el => {
            if (el.id === 'search-anchor' && replaceData.value !== '') {
                (<HTMLElement>el).innerText = replaceData.value;
                myRef.value.saveDocData(false);
            }
        })
    } else if (type === 'whole') {
        [...document.querySelectorAll('.keyword_search')].forEach(el => {
            (<HTMLElement>el).innerText = replaceData.value;
            myRef.value.saveDocData(false);
        })
    }

}
const stopSearchKeyword = () => {
    mainStore.isInSearch = showSearchBox.value = false;
    db.opus.get(query_id).then(value => {
        if (value) myRef.value.setBooksData(value, keywordMarks.value);
    })
}

/*-------------æ•°æ®ç»Ÿè®¡ä¸åˆå§‹åŒ–-------------*/
const wordCount = ref(0), charCount = ref(0), paragraphs = ref(0),
    fontList = ref(), paperSize = ref([
        { type: 'Max', size: 1280, now: false },
        { type: 'iPad Pro', size: 1024, now: false },
        { type: 'A4', size: 794, now: true },
        { type: 'iPad', size: 768, now: false },
        { type: 'Surface Duo', size: 540, now: false },
        { type: 'iPhone6/7/8 Plus', size: 414, now: false },
        { type: 'iPhone6/7/8 X', size: 375, now: false },
        { type: 'iPhone5/SE', size: 320, now: false },
        { type: 'Galaxy Fold', size: 280, now: false }]);

//è·å¾—å­ç»„ä»¶ä¼ é€’çš„è®°æ•°
const getData = (data: Pagecount) => {
    wordCount.value = data.wordCount;
    charCount.value = data.charCount;
    paragraphs.value = data.paragraphs;
}

// è¯»å–æœ¬åœ°ç”¨æˆ·ç¼“å­˜è®¾ç½®(localStorageç¼“å­˜çŠ¶æ€)
const uWritingOption = ref({
    uFontSize: 22,
    uLineHeight: 1.5,
    uFontWeight: 'normal',
    uFont: 'KaiTi',
    uColor: '#333333',
    uSpacing: 10,
    uTextIndent: '0',
    uParaFocus: 'close',
    uBgcColor: '#ffffff',
    uPaperSize: 'A4'
});
const getuWritingOption = localStorage.getItem('uWritingOption');
if (getuWritingOption === null) {
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
} else {
    uWritingOption.value = JSON.parse(getuWritingOption);
}

/*----è·å–ç³»ç»Ÿå­—ä½“åˆ—è¡¨å¤‡ç”¨----*/
let _fontList: Array<string>, slideDown: number = 1;
window.$API.ipcSend('count-fonts-item');
window.$API.ipcOn('get-fonts-item', (data: Array<string>) => {
    // è¿™é‡Œå¯ä»¥é€šè¿‡åˆ†æå†…å®¹æ˜¯ä¸­æ–‡è¿˜æ˜¯è‹±æ–‡é€‰æ‹©æ˜¯å¦é€†åº
    _fontList = data.reverse();
    if (data.length > 20) {
        // åˆ—è¡¨æ‹†åˆ†ä¸º20ä¸€ç»„
        slideDown = data.length % 20 === 0 ? data.length / 20 : Math.floor(data.length / 20);
        // é¦–å…ˆæ¸²æŸ“20ä¸ª
        fontList.value = _fontList.slice(1, 20);
    } else {
        fontList.value = _fontList;
    }
});

/*----é€šè¿‡Scrollæ»šåŠ¨äº‹ä»¶æ‡’åŠ è½½å­—å­—ä½“åˆ—è¡¨----*/
const fontListNode = ref();
let count = 0, countSlideDown = 1, scrollTop: Array<number> = [];
// è§¦å‘èŠ‚æµå‡½æ•°
const fontlistScroll = throttle(() => {
    count++;
    if (count === 1) {
        scrollTop[0] = fontListNode.value.scrollTop;
    } else if (count === 2) {
        scrollTop[1] = fontListNode.value.scrollTop;
        count = 0;
        // ä¸‹æ»‘æ“ä½œæ—¶åŠ è½½æ–°å­—ä½“åˆ—è¡¨
        if (scrollTop[1] > scrollTop[0]) {
            if (countSlideDown <= slideDown) {
                for (let i = 0; i < 20; i++) {
                    if (_fontList[i + countSlideDown * 20] === undefined) break;
                    fontList.value.push(_fontList[i + countSlideDown * 20])
                }
            }
            countSlideDown++;
        }
    }
}, 100);

/*----å­—æ•°ç»Ÿè®¡é€‰æ‹©----*/
const choiceArr = ref([true, false, false]);
const choice = (order: number) => {
    choiceArr.value = [false, false, false];
    choiceArr.value[order] = !choiceArr.value[order];
}
const showChoice = computed(() => {
    let tempStr = '';
    if (choiceArr.value[0]) tempStr = wordCount.value + ' å­—';
    if (choiceArr.value[1]) tempStr = charCount.value + ' ä¸ª';
    if (choiceArr.value[2]) tempStr = paragraphs.value + ' æ®µ';
    return tempStr;
})

/*----çˆ¶ç»„ä»¶è°ƒç”¨å­ç»„ä»¶çš„æ–¹æ³•----*/
// å¯¼å‡ºæ–‡ä»¶
const myRef = ref();
const exp = (type: string) => {
    myRef.value.expFile(type);
}
// è®¾ç½®å­—ä½“
const selectFont = (i: number) => {
    myRef.value.setFont(fontList.value[i]);
    uWritingOption.value.uFont = fontList.value[i];
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// ä¿®æ”¹å­—ä½“å¤§å°
const fontSize = ref(uWritingOption.value.uFontSize);
const changeFontSize = () => {
    myRef.value.setFontSize(fontSize.value);
    uWritingOption.value.uFontSize = fontSize.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// ä¿®æ”¹å­—ä½“è¡Œé«˜
const lineHeight = ref(uWritingOption.value.uLineHeight);
const changeLineHeight = () => {
    myRef.value.setLineHeight(lineHeight.value);
    uWritingOption.value.uLineHeight = lineHeight.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// ä¿®æ”¹å­—ä½“ç²—ç»†
const fontWeight = ref(uWritingOption.value.uFontWeight);
const changeFontWeight = () => {
    myRef.value.setFontWeight(fontWeight.value);
    uWritingOption.value.uFontWeight = fontWeight.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// ä¿®æ”¹æ®µè½é—´è·
const segSpacing = ref(uWritingOption.value.uSpacing);
const changeSegSpacing = () => {
    myRef.value.setSegSpacing(segSpacing.value);
    uWritingOption.value.uSpacing = segSpacing.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// ä¿®æ”¹æ®µå‰ç¼©è¿›
const textIndent = ref(uWritingOption.value.uTextIndent);
const changeTextIndent = () => {
    myRef.value.setTextIndent(textIndent.value);
    uWritingOption.value.uTextIndent = textIndent.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}

// è·å¾—å­ç»„ä»¶é€‰æ‹©çš„colorå¹¶ä¿®æ”¹å­—ä½“é¢œè‰²
const fontColor = ref(uWritingOption.value.uColor), bgcColor = ref(uWritingOption.value.uBgcColor);
const gradientColor = ref("linear-gradient(0deg, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 1) 100%)");
const getColor = () => {
    myRef.value.setColor(fontColor.value);
    // èšç„¦æ¨¡å¼ä¸‹é€‰æ‹©æ–°é¢œè‰²
    if (paraFocus.value === 'open') myRef.value.setParaFocus(paraFocus.value);
    uWritingOption.value.uColor = fontColor.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// è·å¾—å­ç»„ä»¶é€‰æ‹©çš„colorå¹¶ä¿®æ”¹çº¸å¼ èƒŒæ™¯è‰²
const getBgcColor = () => {
    myRef.value.setBgcColor(bgcColor.value);
    uWritingOption.value.uBgcColor = bgcColor.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}
// è®¾ç½®çº¸å¼ ç±»å‹
for (let item in paperSize.value) {
    paperSize.value[item].now = false;
    if (paperSize.value[item].type === uWritingOption.value.uPaperSize) {
        paperSize.value[item].now = true;
    }
}
const changePaperSize = (type: string) => {
    paperSize.value.forEach(item => {
        item.now = false;
        item.type === type ? item.now = true : null;
    });
    myRef.value.setPaperSize(type);
    uWritingOption.value.uPaperSize = type;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}

// è®¾ç½®èšç„¦æ¨¡å¼
const paraFocus = ref(uWritingOption.value.uParaFocus);
const changeParaFocus = () => {
    myRef.value.setParaFocus(paraFocus.value);
    uWritingOption.value.uParaFocus = paraFocus.value;
    localStorage.setItem('uWritingOption', JSON.stringify(uWritingOption.value));
}

/*----å·¦ä¾§æ åŠŸèƒ½----*/
const onClickMenuItem = (tvid: string, tcid: string) => {
    if (tcid !== cid.value) {
        setScrollTop(<string>vid.value, <string>cid.value);
        vid.value = tvid;
        cid.value = tcid;
        myRef.value.setId(tvid, tcid);
        const toDisplay: Array<object> = [];
        db.opus.get(query_id).then(value => {
            if (value) {
                for (let i = 0; i < value.data.length; i++) {
                    if (value.data[i].vid === tvid) {
                        for (let j = 0; j < value.data[i].volume.length; j++) {
                            if (value.data[i].volume[j].cid === tcid) {
                                value.data[i].volume[j].chapter.forEach((item: string) => {
                                    toDisplay.push({
                                        type: "paragraph",
                                        content: [
                                            {
                                                type: "text",
                                                text: item
                                            }
                                        ]
                                    });
                                });
                                break;
                            }
                        }
                        break;
                    }
                }
            }
            loadListData();
            if (showSearchBox.value) {
                toSearchKeyword();
                mainStore.targetIndex = 1;
            } else {
                myRef.value.refreshPaper(toDisplay, []);
            }
        })
    }
}

// å·¦æ å±•å¼€æ›´å¤šæ“ä½œ
const editVid1 = ref(''), editVid2 = ref(''), editVid3 = ref(''), showLeftMore = ref('');

// é‡å‘½å
const isRename = ref(false), showName = ref('');
let temp_id: string, reType: string = '';
const showReName = (type: string, id: string, vname: string) => {
    isRename.value = true;
    reType = type; // é‡å‘½åç±»å‹
    temp_id = id;
    showName.value = vname;
}
const reName = () => {
    // ä¿®æ”¹å·
    if (reType === 'v') {
        db.opus.where(':id').equals(query_id).modify(item => {
            for (let i = 0; i < item.data.length; i++) {
                if (item.data[i].vid === temp_id) {
                    item.data[i].volumeName = showName.value;
                    break;
                }
            }
        }).then(() => {
            isRename.value = false;
            loadListData();
        })
    }
    // ä¿®æ”¹ç« 
    else if (reType === 'c') {
        db.opus.where(':id').equals(query_id).modify(item => {
            for (let i = 0; i < item.data.length; i++) {
                for (let j = 0; j < item.data[i].volume.length; j++) {
                    if (item.data[i].volume[j].cid === temp_id) {
                        item.data[i].volume[j].chapterName = showName.value;
                        break;
                    }
                }
            }
        }).then(() => {
            isRename.value = false;
            loadListData();
        })
    }
}

// åˆ é™¤ç« ï¼ˆç§»è‡³åºŸçº¸ç¯“ï¼‰
const deletedCid = ref('');
const deleteChapter = (dvid: string, dcid: string, cname: string) => {
    $modal.warning({
        title: "åˆ é™¤ç« ",
        content: `ç›®æ ‡ç« ã€Š${cname}ã€‹å°†æ”¾å…¥åºŸçº¸ç¯“,å¹¶ä¿ç•™30å¤©`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                for (let i = 0; i < item.data.length; i++) {
                    if (item.data[i].vid === dvid) {
                        for (let j = 0; j < item.data[i].volume.length; j++) {
                            if (item.data[i].volume[j].cid === dcid) {
                                item.data[i].volume[j].discard = true;
                                item.data[i].volume[j].discardTime = new Date().getTime();
                                break;
                            }
                        }
                        break;
                    }
                }
            }).then(() => {
                // åˆ é™¤çš„ç›®æ ‡æ˜¯å½“å‰ç¼–è¾‘çš„ç›®æ ‡
                if (dvid === vid.value && dcid === cid.value) {
                    deletedCid.value = dcid;
                    myRef.value.refreshPaper([{
                        type: "paragraph",
                        content: [
                            {
                                type: "text",
                                text: ''
                            }
                        ]
                    }]);
                } else {
                    loadListData();
                }
                $message.success('åˆ é™¤æˆåŠŸ!');
            })
        }
    })
}

// åˆ é™¤å·ï¼ˆç§»è‡³åºŸçº¸ç¯“ï¼‰
const deleteVolume = (vid: string, vname: string) => {
    $modal.warning({
        title: "åˆ é™¤å·",
        content: `ç›®æ ‡å·ã€${vname}ã€‘å°†æ”¾å…¥åºŸçº¸ç¯“,å¹¶ä¿ç•™30å¤©`,
        simple: true,
        onOk: () => {
            db.opus.where(':id').equals(query_id).modify(item => {
                for (let i = 0; i < item.data.length; i++) {
                    if (item.data[i].vid === vid) {
                        item.data[i].discard = true;
                        item.data[i].discardTime = new Date().getTime();
                        break;
                    }
                }
            }).then(() => {
                loadListData();
                $message.success('åˆ é™¤æˆåŠŸ!');
            })
        }
    })
}

// ç‚¹å‡»æ·»åŠ ç« 
const isNewChapter = ref(false), chapterName = ref('æœªå‘½åç« ');
let volumeId: string; // æ‰¾åˆ°ç›®æ ‡å·æ‰èƒ½å‘é‡Œé¢pushç« 
const newChapter = (vid: string) => {
    volumeId = vid;
    isNewChapter.value = true;
}
const addNewChapter = () => {
    db.opus.where(':id').equals(query_id).modify(item => {
        for (let i = 0; i < item.data.length; i++) {
            if (item.data[i].vid === volumeId) {
                item.data[i].volume.push({
                    cid: v4(),
                    chapterName: chapterName.value,
                    updateTime: new Date().getTime(),
                    chapter: ['\u3000\u3000']
                });
                break;
            }
        }
    }).then(() => {
        isNewChapter.value = false;
        loadListData();
        $message.success('æ·»åŠ æˆåŠŸ!');
    })
}

// ç‚¹å‡»æ·»åŠ å·
const isNewVolume = ref(false), volumeName = ref('æœªå‘½åå·');
const addNewVolume = () => {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.data.push({
            vid: v4(),
            volumeName: volumeName.value,
            updateTime: new Date().getTime(),
            volume: [{
                cid: v4(),
                chapterName: 'æœªå‘½åç« ',
                updateTime: new Date().getTime(),
                chapter: ['\u3000\u3000']
            }]
        });
    }).then(() => {
        isNewVolume.value = false;
        loadListData();
        $message.success('æ·»åŠ æˆåŠŸ!');
    })
}

/*----å³ä¾§æ»šåŠ¨æ¡çš„æ ·å¼è®¾ç½®----*/
const scrollbarColor = ref('#ccc');
const showScroll = () => {
    scrollbarColor.value = '#ccc';
}
const closeScroll = () => {
    scrollbarColor.value = '#f5f5f5';
}

const resizeBoxMoving = () => {
    if (ref_TimelineEditor.value) ref_TimelineEditor.value.setSliderState();
}

// å³ä¾§PopButtoné€‰æ‹©å¹¶æ¸²æŸ“å¯¹åº”ç»„ä»¶
const popupVisible = ref(false), showModular = ref('1');
if (localStorage.getItem('showModular') === null) {
    localStorage.setItem('showModular', '1');
} else {
    showModular.value = localStorage.getItem('showModular') ?? '1';
}
const choicePopButton = (key: string) => {
    showModular.value = key;
    localStorage.setItem('showModular', key);
}

const modify = () => {
    isRename.value = false;
    isNewVolume.value = false;
    isNewChapter.value = false;
}

// æ è¿‡å…³é”®å­—æ‰€åœ¨çš„span
const showkeywordDetail = ref(false), keywordDetail = ref();
let kid_iid_old = ''; // ç”¨æ¥é˜²æŒ‡å¤šæ¬¡è§¦å‘å¤šæ¬¡è®¿é—®æ•°æ®åº“æ‹¿å–åŒä¸€æ®µæ•°æ®
const showSpanDetail = throttle((e: MouseEvent) => {
    if ((<HTMLElement>e.target).getAttribute('class') === 'keyWord') {
        showkeywordDetail.value = true;
        const targetText = (<HTMLElement>e.target).innerText;
        let posX: number, posY: number, domRect = (<HTMLElement>e.target).getBoundingClientRect();
        [posX, posY] = [domRect.x + domRect.width, domRect.y + domRect.height];
        keyWordArr.forEach(item => {
            for (let i = 2; i < item.length; i++) {
                if (item[i] === targetText) {
                    let kid_iid_new = item[0] + item[1];
                    if (kid_iid_new !== kid_iid_old) {
                        kid_iid_old = kid_iid_new;
                        modifyDbforItem(item[0], item[1], (item: Userdb) => {
                            // console.log(item);
                        }, () => {

                        })
                    }
                    break;
                }
            }
        })
        nextTick(() => {
            keywordDetail.value.style.top = posY - keywordDetail.value.clientHeight / 2 - domRect.height / 2 + 'px';
            keywordDetail.value.style.left = posX + 10 + 'px';
        })
    } else {
        showkeywordDetail.value = false;
    }
}, 50)

// è·å–é¡µé¢ä¸Šä¸‹ç›¸å¯¹ä½ç½®
let temp_scrollTop = 0;
const getScrollTop = (e: Event) => {
    temp_scrollTop = (<HTMLElement>e.target).scrollTop;
}
// è®¾ç½®çº¸å¼ è·ç¦»é¡¶éƒ¨çš„é«˜åº¦ï¼ˆç”¨æˆ·è·³è½¬è‡³ç¼–è¾‘ä½ç½®
function setScrollTop(tvid: string, tcid: string) {
    db.opus.where(':id').equals(query_id).modify(item => {
        for (let i = 0; i < item.data.length; i++) {
            if (item.data[i].vid === tvid) {
                for (let j = 0; j < item.data[i].volume.length; j++) {
                    if (item.data[i].volume[j].cid === tcid) {
                        item.data[i].volume[j].scrollTop = temp_scrollTop;
                        break;
                    }
                }
                break;
            }
        }
    })
}
// è·å–åˆ—è¡¨æ•°æ®
const router = useRouter();
const booksLists: { data: Array<Volume> } = reactive({ data: [] });
let keyWordArr: Array<Array<string>> = [];
function loadListData() {
    db.opus.get(query_id).then(value => {
        if (value) {
            // åŠ è½½å…³é”®è¯
            keyWordArr = [];
            value.theKeyWord.forEach(item => {
                let tempArr: Array<string> = [];
                item.data.forEach(it => {
                    tempArr = it.otherName;
                    tempArr.unshift(item.kid, it.iid, it.itemName);
                    // å»é‡
                    keyWordArr.push([...new Set(tempArr)]);
                })
            })
            // æ¸²æŸ“å…³é”®è¯
            keywordMarks.value = genkeywordMarks(keyWordArr);
            myRef.value.setBooksData(value, keywordMarks.value);
            // åŠ è½½å·ç« åˆ—è¡¨
            booksLists.data = value.data.filter((item: Volume) => {
                // åˆ¤æ–­ç›®æ ‡å·æ˜¯å¦æœ‰åˆ é™¤æ ‡è®°
                return !item.discard;
            });
            booksLists.data.forEach((item: Volume) => {
                item.volume = item.volume.filter((it: Chapter) => {
                    // åˆ¤æ–­ç›®æ ‡ç« æ˜¯å¦æœ‰åˆ é™¤æ ‡è®°
                    return !it.discard;
                })
            });
            if (booksLists.data.length === 0) {
                router.push({
                    path: '/detail',
                    query: {
                        type: 'opus',
                        id: query_id
                    }
                })
            }
            // è®¾ç½®é»˜è®¤çš„scrollTop
            for (let i = 0; i < booksLists.data.length; i++) {
                if (booksLists.data[i].vid === vid.value) {
                    for (let j = 0; j < booksLists.data[i].volume.length; j++) {
                        if (booksLists.data[i].volume[j].cid === cid.value) {
                            (<HTMLElement>document.querySelector('.arco-layout-content')).scrollTop =
                                <number>booksLists.data[i].volume[j].scrollTop;
                            break;
                        }
                    }
                    break;
                }
            }
        }
    })
}

/*----è‡ªå®šä¹‰å…¨å±€å¿«æ·é”®----*/
//è·å–è·¯ç”±å‚æ•°ç¡®å®šè¯¦æƒ…é¡µæ˜¾ç¤ºçš„ç›®æ ‡
const searchInput = ref();
window.addEventListener('keydown', shortcut);
window.addEventListener('click', leftMoreControl);
function shortcut(e: KeyboardEvent) {
    if (deletedCid.value === cid.value) {
        // Ctrl+S
        if (e.ctrlKey === true && e.key === 's') $message.error('ç›®æ ‡å·²è¢«åˆ é™¤!');
    } else {
        // Ctrl+S
        if (e.ctrlKey === true && e.key === 's') myRef.value.saveDocData(true);
        if (e.ctrlKey === true && e.key === 'f') {
            showSearchBox.value = true;
            nextTick(() => {
                searchInput.value.focus();
            })
        }
    }
}
function leftMoreControl() {
    showLeftMore.value = '';
}
// æ‰¾åˆ°å…³é”®å­—æ•°æ®
function modifyDbforItem(t_kid: string, t_iid: string, hd: Function, cb?: Function) {
    db.opus.where(':id').equals(query_id).modify(item => {
        item.theKeyWord.forEach(item => {
            if (item.kid === t_kid) {
                item.data.forEach(it => {
                    if (it.iid === t_iid) hd(it);
                })
            }
        })
    }).then(() => {
        if (cb) cb();
    })
}

/*---------------------ç”Ÿå‘½å‘¨æœŸ---------------------*/
onMounted(() => {
    const mainEditor = document.getElementById('mainEditor');
    mainEditor?.addEventListener('mousemove', showSpanDetail);

    nextTick(() => {
        // console.log(document.getElementsByClassName('keyWord'));

        myRef.value.setFont(uWritingOption.value.uFont, true);
        myRef.value.setFontSize(uWritingOption.value.uFontSize, true);
        myRef.value.setLineHeight(uWritingOption.value.uLineHeight, true);
        myRef.value.setFontWeight(uWritingOption.value.uFontWeight, true);
        myRef.value.setSegSpacing(uWritingOption.value.uSpacing, true);
        myRef.value.setTextIndent(uWritingOption.value.uTextIndent, true);
        myRef.value.setColor(uWritingOption.value.uColor, true);
        myRef.value.setBgcColor(uWritingOption.value.uBgcColor, true);
        myRef.value.setPaperSize(uWritingOption.value.uPaperSize, true);
        myRef.value.setParaFocus(uWritingOption.value.uParaFocus, true);
    })
})
onBeforeUnmount(() => {
    setScrollTop(<string>vid.value, <string>cid.value);
    db.opus.update(query_id, { historRecord: { vid: vid.value, cid: cid.value } });
})
onUnmounted(() => {
    window.removeEventListener('keydown', shortcut);
    window.removeEventListener('click', leftMoreControl);
})

</script>

<style scoped>
::-webkit-scrollbar-track {
    box-shadow: none;
    border-radius: 0;
    border-left: 1px dashed #e5e6eb;
}
::-webkit-scrollbar-thumb {
    background-color: v-bind(scrollbarColor);
    border-radius: 0;
    border-left: 1px dashed #e5e6eb;
}
.trigger::-webkit-scrollbar-thumb {
    background-color: #f2f3f5;
}
.layout-write :deep(.arco-layout-header) {
    height: 35px;
    border-bottom: 2px dashed #e5e6eb;
    background-color: #fff;
}

.layout-write :deep(.arco-layout-content) {
    height: calc(100vh - 85px);
    min-width: 20px;
    background-color: #fff;
    overflow-y: scroll;
}
</style>